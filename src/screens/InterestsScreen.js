import { collection, doc, onSnapshot, query, where } from "firebase/firestore";
import React, { useEffect, useState } from "react";
import {
  ActivityIndicator,
  Button,
  FlatList,
  Pressable,
  Text,
  View,
} from "react-native";
import { auth, db } from "../firebase";
import EventCard from "../ui/EventCard";

export default function InterestsScreen({ navigation }) {
  const [events, setEvents] = useState([]);
  const [tab, setTab] = useState("Interests");
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");

  useEffect(() => {
    const uid = auth.currentUser.uid;
    const userRef = doc(db, "users", uid);
    const unsubUser = onSnapshot(
      userRef,
      (snap) => {
        const interests = snap.data()?.interests || [];
        if (!interests.length) {
          setEvents([]);
          setLoading(false);
          return;
        }
        const q = query(
          collection(db, "events"),
          where("__name__", "in", interests.slice(0, 10))
        );
        const unsubEvents = onSnapshot(
          q,
          (ss) => {
            setEvents(ss.docs.map((d) => ({ id: d.id, ...d.data() })));
            setLoading(false);
          },
          (err) => {
            setError(err.message);
            setLoading(false);
          }
        );
        return () => unsubEvents();
      },
      () => {
        // if user doc doesn't exist yet, stop loading gracefully
        setEvents([]);
        setLoading(false);
      }
    );
    return () => unsubUser();
  }, []);

  function SegmentedButton({ label, selected, onPress }) {
    return (
      <Pressable
        onPress={onPress}
        style={{
          flex: 1,
          paddingVertical: 10,
          borderRadius: 8,
          marginHorizontal: 6,
          backgroundColor: selected ? "#2563eb" : "#fff",
          boxShadow: "0 4px 12px rgba(0,0,0,0.1)",
          alignItems: "center",
        }}
      >
        <Text
          style={{
            color: selected ? "#fff" : "#222",
          }}
        >
          {label}
        </Text>
      </Pressable>
    );
  }

  return (
    <View style={{ flex: 1, padding: 12 }}>
      <View style={{ flexDirection: "row", marginBottom: 12 }}>
        <SegmentedButton
          label="Interests"
          selected={tab === "Interests"}
          onPress={() => setTab("Interests")}
        />
        <SegmentedButton
          label="Create"
          selected={tab === "Create"}
          onPress={() => setTab("Create")}
        />
      </View>

      {tab === "Create" ? (
        <View>
          <Button
            title="Create Event"
            onPress={() => navigation.navigate("CreateEvent")}
          />
          <View style={{ height: 8 }} />
          <Button
            title="Create Group"
            onPress={() => navigation.navigate("CreateGroup")}
          />
        </View>
      ) : loading ? (
        <ActivityIndicator />
      ) : error ? (
        <Text style={{ color: "#b91c1c" }}>{error}</Text>
      ) : (
        <FlatList
          data={events}
          keyExtractor={(item) => item.id}
          ListEmptyComponent={() => (
            <Text style={{ opacity: 0.6 }}>No interested events yet.</Text>
          )}
          renderItem={({ item }) => (
            <EventCard
              event={item}
              onPress={() =>
                navigation.navigate("EventDetails", { id: item.id })
              }
            />
          )}
        />
      )}
    </View>
  );
}
